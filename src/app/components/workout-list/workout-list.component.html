<div class="mx-auto flex flex-col gap-4 md:max-w-[1400px]">
  <div class="flex flex-col gap-2">
    <h1 class="text-3xl font-bold tracking-tight">ワークアウトカレンダー</h1>
    <p class="text-muted-foreground">
      カレンダーでトレーニング記録を確認できます。
    </p>
  </div>

  <!-- レイアウト修正: flexを使用して確実に横並びにする -->
  <div class="flex flex-col md:flex-row gap-6">
    <!-- カレンダー部分: 幅を固定 -->
    <div class="md:w-2/3 space-y-4">
      <!-- カレンダーヘッダー -->
      <div
        class="flex items-center justify-between bg-card rounded-lg border p-4"
      >
        <button
          (click)="changeMonth(-1)"
          class="inline-flex items-center justify-center rounded-md text-sm font-medium h-10 px-4 hover:bg-accent"
        >
          前月
        </button>
        <h2 class="text-xl font-semibold">
          {{ currentDate | date : "Y年M月" }}
        </h2>
        <button
          (click)="changeMonth(1)"
          class="inline-flex items-center justify-center rounded-md text-sm font-medium h-10 px-4 hover:bg-accent"
        >
          次月
        </button>
      </div>

      <!-- カレンダーグリッド -->
      <div class="bg-card rounded-lg border overflow-hidden">
        <!-- 曜日ヘッダー -->
        <div class="grid grid-cols-7 gap-px bg-muted">
          @for (day of ['日', '月', '火', '水', '木', '金', '土']; track day) {
          <div class="bg-card p-3 text-center text-sm font-medium">
            {{ day }}
          </div>
          }
        </div>

        <!-- カレンダー日付 -->
        <div class="grid grid-cols-7 gap-px bg-muted">
          @for (date of calendarDays; track date) {
          <div
            [class.bg-card]="true"
            [class.opacity-40]="!isCurrentMonth(date)"
            [class.cursor-pointer]="isCurrentMonth(date)"
            [class.hover:bg-accent]="isCurrentMonth(date)"
            [class.bg-accent]="
              workoutService.getDateString(date) === selectedDate
            "
            class="min-h-[80px] p-2 transition-colors"
            (click)="selectDate(date)"
          >
            <div class="flex items-start justify-between">
              <div class="flex items-center gap-1">
                @if (isToday(date)) {
                <div
                  class="h-7 w-7 rounded-full bg-primary text-primary-foreground flex items-center justify-center"
                >
                  {{ date | date : "d" }}
                </div>
                } @else {
                <div class="h-7 w-7 flex items-center justify-center">
                  {{ date | date : "d" }}
                </div>
                }
              </div>

              @if (isCurrentMonth(date) && hasWorkout(date)) {
              <div
                class="text-xs font-medium px-2 py-1 rounded-full bg-primary/10 text-primary"
              >
                {{ getWorkoutCount(date) }}種目
              </div>
              }
            </div>
          </div>
          }
        </div>
      </div>
    </div>

    <!-- 詳細表示部分: 幅を固定 -->
    <div class="md:w-1/3">
      @if (selectedDate && getSelectedWorkouts()) {
      <div class="bg-card rounded-lg border p-6 sticky top-4">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-lg font-semibold">
            {{ selectedDate | date : "Y年M月d日" }}のワークアウト
          </h3>
          <button
            (click)="deleteWorkouts(selectedDate, $event)"
            class="text-sm text-destructive hover:text-destructive/80"
          >
            削除
          </button>
        </div>

        <div class="space-y-4 max-h-[calc(100vh-12rem)] overflow-y-auto pr-2">
          @for (workout of getSelectedWorkouts()!; track workout.id) { @for
          (exercise of workout.exercises; track exercise.name) {
          <div class="border rounded-lg">
            <button
              (click)="toggleExercise(workout.id, exercise.name)"
              class="w-full px-4 py-3 flex items-center justify-between hover:bg-accent/50 rounded-lg transition-colors"
            >
              <div class="flex items-center gap-3">
                <h4 class="font-medium">{{ exercise.name }}</h4>
                <span
                  class="text-sm px-2 py-0.5 rounded-full bg-secondary text-secondary-foreground"
                >
                  {{ exercise.sets.length }}セット
                </span>
              </div>
              <div
                class="flex items-center gap-2 text-sm text-muted-foreground"
              >
                <svg
                  [class.rotate-180]="
                    isExerciseExpanded(workout.id, exercise.name)
                  "
                  class="h-4 w-4 transition-transform"
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  strokeWidth="2"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                >
                  <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
              </div>
            </button>

            @if (isExerciseExpanded(workout.id, exercise.name)) {
            <div class="px-4 pb-3 space-y-3">
              @for (set of exercise.sets; track $index) {
              <div
                class="flex items-center justify-between text-sm pl-4 border-l-2 border-muted"
              >
                <div class="flex items-center gap-6">
                  <span class="text-muted-foreground"
                    >セット{{ $index + 1 }}</span
                  >
                  <div class="flex items-baseline gap-1">
                    <span class="text-base font-medium">{{ set.weight }}</span>
                    <span class="text-muted-foreground">kg</span>
                  </div>
                  <div class="flex items-baseline gap-1">
                    <span class="text-base font-medium">{{ set.reps }}</span>
                    <span class="text-muted-foreground">回</span>
                  </div>
                </div>
                <div class="text-muted-foreground">
                  {{ set.weight * set.reps }}kg
                </div>
              </div>
              }
            </div>
            }
          </div>
          } }
        </div>
      </div>
      } @else {
      <div
        class="bg-card rounded-lg border p-6 text-center text-muted-foreground sticky top-4"
      >
        日付を選択してください
      </div>
      }
    </div>
  </div>
</div>
